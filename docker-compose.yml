# docker-compose.yml
version: "3.9"

services:
  refresher:
    build:
      context: ./app
    container_name: refresher
    env_file:
      - ./.env
    environment:
      - SYMLINK_ROOT=/opt/media/jelly
      - MOUNT_ROOT=/mnt/remote/realdebrid
      - REFRESHER_LOG_LEVEL=INFO
    volumes:
      - ./config:/app/config 
      - ./data:/data
      - /opt/media:/opt/media:rw
      # Left side must be the HOST path where the real files live:
      - /opt/media/remote/realdebrid:/mnt/remote/realdebrid:ro
    # run the known-good loop from scanner
    command: ["python", "-c", "from refresher.core.scanner import run_loop; run_loop(300)"]
    restart: unless-stopped
    healthcheck:
      # dry, non-destructive scan; unhealthy only if mount missing
      test: ["CMD", "python", "-m", "refresher.core.scanner", "--json"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      research-relay:
        condition: service_healthy

  research-relay:
    build:
      context: ./services/research-relay
    container_name: research-relay
    env_file:
      - ./.env
    ports:
      - "5050:5050"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5050/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 15s

