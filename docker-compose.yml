version: "3.9"
services:
  refresher:
    build:
      context: ./app
    container_name: refresher
    env_file:
      - ./.env
    volumes:
      - ./config:/config
      - ./data:/data
      - /opt/media:/opt/media:rw
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import os; import sys; sys.exit(0 if os.path.exists('/data') else 1)"]
      interval: 30s
      timeout: 5s
      retries: 5
    depends_on:
      - research-relay

  research-relay:
    build:
      context: ./services/research-relay
    container_name: research-relay
    env_file:
      - ./.env
    ports:
      - "5050:5050"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5050/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
