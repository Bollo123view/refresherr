version: '3.8'

# Refresherr - Single Container Architecture
# All-in-one container with scanner, dashboard API, React UI, and relay logic

services:
  refresherr:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: refresherr
    env_file:
      - .env
    environment:
      # Core settings (override via .env)
      - CONFIG_FILE=/config/config.yaml
      - DATA_DIR=/data
      - DRYRUN=${DRYRUN:-true}
      - SCAN_INTERVAL=${SCAN_INTERVAL:-300}
      
      # Internal relay (runs on localhost for single-container mode)
      - RELAY_BASE=${RELAY_BASE:-http://localhost:5050}
      - RELAY_TOKEN=${RELAY_TOKEN:-internal}
      
      # Dashboard settings
      - FLASK_SECRET=${FLASK_SECRET:-change-me-to-random-string}
      - PORT=8088
      
      # Optional: Discord notifications (webhook URL)
      # Get webhook from Discord: Server Settings > Integrations > Webhooks
      # Format: https://discord.com/api/webhooks/ID/TOKEN
      - DISCORD_WEBHOOK=${DISCORD_WEBHOOK:-}
      
      # CineSync Configuration (optional - for hotswap repair from library)
      # Base path to your CineSync library structure
      - CINESYNC_BASE=${CINESYNC_BASE:-/opt/media/jelly/cinesync/CineSync}
      
      # Comma-separated list of paths to repair (where broken symlinks live)
      - CINESYNC_REPAIR_ROOTS=${CINESYNC_REPAIR_ROOTS:-/opt/media/jelly/tv,/opt/media/jelly/movies}
      
      # Safety: dry-run mode for CineSync (1=dry-run, 0=live repairs)
      - CINESYNC_DRY_RUN=${CINESYNC_DRY_RUN:-1}
      
      # Limit on broken symlinks to attempt per CineSync run
      - CINESYNC_LIMIT=${CINESYNC_LIMIT:-200}
      
      # Comma-separated allowed target prefixes (for security)
      - CINESYNC_ALLOWED_TARGET_PREFIXES=${CINESYNC_ALLOWED_TARGET_PREFIXES:-/mnt/remote}
    
    volumes:
      # Configuration files (read-only - contains config.yaml)
      - ./config:/config:ro
      
      # Data directory (read-write - SQLite database and logs)
      - ./data:/data
      
      # Media symlink root (read-write - Refresherr repairs broken symlinks here)
      # Example: /opt/media/jelly contains your Jellyfin/Plex library symlinks
      # IMPORTANT: Adjust this path to match your actual media library location
      - /opt/media:/opt/media:rw
      
      # Actual file storage (read-only - RealDebrid/cloud mount)
      # Example: /mnt/realdebrid is where your rclone mount points
      # IMPORTANT: Adjust this path to your actual cloud/RealDebrid mount location
      - /mnt/realdebrid:/mnt/remote/realdebrid:ro
    
    ports:
      - "${PORT:-8088}:8088"
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Optional: Security hardening
    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - CHOWN
    #   - DAC_OVERRIDE

# No networks needed - everything runs in single container
